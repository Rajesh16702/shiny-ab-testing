---
title: "sandbox"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)
library(tidyverse)
library(scales)
library(lubridate)
```

```{r simulate_user_traffic}
# unique daily visits e.g. 1 record means that the person may have visited the site 1+ times for that day (the number of times does not matter)
# what is the distribution of returning visitors? i.e. how many unique days will most people visit the website?

# 20K visits users per month, over 10 months
total_visits_per_unique_data <- 100000
#return_visit
#user_traffic
set.seed(42)
ids <- floor(runif(total_visits_per_unique_data, min=1, max=total_visits_per_unique_data * 0.50))
num_unique_ids <- length(unique(ids))

visits <- data.frame(user_id=ids) %>%
    arrange(user_id)

visits %>%
    count(user_id) %>%
    count(n) %>%
    mutate(n=factor(n),
           nn=nn / num_unique_ids) %>%
    rename(unique_days_visited=n,
           number_of_ids=nn) %>%
    ggplot(aes(x=unique_days_visited, y=number_of_ids)) +
        geom_col() +
        geom_text(aes(label=percent(number_of_ids)), vjust=-0.3)
```

```{r traffic_2}
# simulate dates over last e.g 10 months
# we need to duplicate ids/days to simulate people visiting multiple paths per day; we'll use this information for our priors
number_of_months <- 10

# unique visitors per month
num_unique_ids / number_of_months

set.seed(42)
first_time_visit_index <- floor(runif(num_unique_ids, min=0, max=300))

# create dataframe with the user-id and the offset that we will use from the current date
# we'll use the current date so we can simulate the latest experiment is currently running 
first_time_users <- data.frame(user_id=unique(ids), visit_offset=first_time_visit_index) %>% 
    arrange(user_id)

first_time_users <- first_time_users %>%
    mutate(first_visit_date=today() - visit_offset) %>%
    select(-visit_offset)

first_time_users %>%
    count(first_visit_date) %>%
    ggplot(aes(x=first_visit_date, y=n)) +
        geom_line() +
        expand_limits(y=0) +
        labs(title='Simulated Daily Visits, no trend')

visits <- inner_join(visits, first_time_users, by = 'user_id')

stopifnot(nrow(visits) == length(ids))
stopifnot(all((visits %>%
    group_by(user_id) %>%
    summarise(num_unique_date=length(unique(first_visit_date))))$num_unique_date == 1))

# now simulate adding number of days between subsequent visits
hist(rgamma(1000, shape=4))


visits <- visits %>%
    group_by(user_id) %>%
    mutate(visit_index = row_number()) %>%
    ungroup()

generate_new_date <- function(visit_index, original_date, user_id) {

    if(visit_index == 1) {
        return (original_date)
    }
    
    set.seed(user_id)
    offset <- floor(rgamma(1, shape=visit_index + 3))
    return (original_date + max(offset, 1))
}

#generate_new_date(visits$visit_index[1], visits$first_visit_date[1], visits$user_id[1])
generated_visits <- pmap(list(visits$visit_index,
                              visits$first_visit_date,
                              visits$user_id),
                         function(x, y, z) generate_new_date(x, y, z))

# pmap is losing the "date" and is returning a number, so we have to convert back; not sure this is the best way
generated_visits <- unlist(generated_visits)
visits$visit_date <- as.Date(generated_visits, origin = Sys.Date() - as.numeric(Sys.Date()))

visits <- visits %>%
    select(user_id, visit_date) %>%
    arrange(user_id, visit_date)

stopifnot(nrow(visits) == length(ids))

# some of the dates generated will be the same. BUT, that could represent multiple different pages in the same day
# so let's add path before we remove duplicates
```

```{r simulate_paths}
# duplicate home-page (example.com) to simulate many more home page visits than other pages
paths <- c('example.com', 'example.com', 'example.com/pricing', 'example.com/features')
set.seed(42)
path_index <- ceiling(runif(nrow(visits), min=0, max=4))
visits$path <- map_chr(path_index, ~ paths[.])

# some of the dates generated will be the same. BUT, that could represent multiple different pages in the same day
# so let's add path before we remove duplicates
visits <- distinct(visits)
nrow(visits)

visits %>%
    count(path) %>%
    ggplot(aes(x=path, y=n)) +
    geom_col() +
    labs(title='Total Visits (day/user) single row represents >=1 visits for that day/user/path')

visits %>%
    group_by(user_id) %>%
    summarise(t=sd(as.numeric(visit_date))) %>%
    ggplot(aes(x=t)) +
        geom_histogram() +
        labs(title='Distribution of Number of Days between Visits')

temp <- inner_join(
    visits %>% 
        group_by(user_id) %>%
        summarise(first_visit_date=min(visit_date)) %>%
        count(first_visit_date) %>%
        rename(date=first_visit_date,
               new_users=n),
    visits %>%
        group_by(visit_date) %>%
        summarise(all_users=n()) %>%
        rename(date=visit_date),
    by='date')

temp %>% 
    gather(user_type, num_users, -date) %>%
    ggplot(aes(x=date, y=num_users, color=user_type)) +
        geom_line()

# visits %>%
#     group_by(user_id) %>%
#     filter(length(visit_date) != length(unique(visit_date))) %>%  # which users have a different number of unique dates fromf total dates
#     ungroup()

visits %>%
    count(visit_date, path) %>%
    ggplot(aes(x=visit_date, y=n, color=path)) +
    geom_line() +
    labs(title='Visits (per day/user) i.e. single row represents >=1 visits for that day/user/path')

prior_data <- visits
```

```{r simulate_metrics_experiments}
# experiment names
experiment_names <- c("Experiment 1", "Experiment 2", "Experiment Sim Currently Running")
# names of the metrics/conversions to track
metrics_names <- c('Sign Up', 'Use Feature 1', 'Talk to Sales', 'Pay/Subscribe')
# allowed number of days between seeing the experiment and giving credit for a conversion
# e.g. signup should happen quick, but we may want to give people more time to subscribe/pay for the service,
# since people want to try out the features before they decide to pay (e.g. if the service offers a trial or freemium)
attribution_windows_days <- c(2, 3, 5, 7)
historical_conversion_rates <- c(0.3, 0.2, 0.1, 0.08)
# conversion_rates contain the conversion rates of each metric for the A & B groups


experiments_metrics <- data.frame(metric_id=metrics_names, attribution_windows=attribution_windows_days)
experiments_metrics <- expand.grid(experiment_id=experiment_names, metric_id=experiments_metrics$metric_id) %>%
    inner_join(experiments_metrics, by = 'metric_id') %>%
    arrange(experiment_id, attribution_windows)

experiments_metrics
```

```{r simulate_experiment_traffic_1}
# for each experiment, we want to simulate, from the current visits/traffic dataset, who saw the experiment, on which page, and which variation

get_random_variation <- function(variation_names, user_id) {
    set.seed(user_id)
    return (variation_names[rbinom(1, 1, 0.5) + 1])
}
#get_random_variation(variation_names, user_id=1)

create_experiment_visits <- function(start_date, end_date, experiment_paths, experiment_id, variation_names) {
    experiment_visits <- visits %>%
        group_by(user_id) %>%
        mutate(visit_index=rank(visit_date, ties.method = "first")) %>%
        ungroup() %>%
        mutate(new_user = ifelse(visit_index == 1, TRUE, FALSE)) %>%
        filter(visit_date >= start_date & visit_date <= end_date & path %in% experiment_paths) %>%
        select(-visit_index)
    
    expected_num_users <- length(unique(experiment_visits$user_id))
    
    experiment_visits <- experiment_visits %>%
        group_by(user_id) %>%
        mutate(visit_index=rank(visit_date, ties.method = "first")) %>%
        ungroup() %>%
        filter(visit_index == 1) %>%
        select(-visit_index) %>%
        rename(first_joined_experiment=visit_date) %>%
        mutate(experiment_id=experiment_id)
    experiment_visits$variation <- map_chr(experiment_visits$user_id, ~ get_random_variation(variation_names, .))
    
    stopifnot(nrow(experiment_visits) == expected_num_users)
    # make sure no duplicated user_ids
    stopifnot(nrow(experiment_visits) == length(unique(experiment_visits$user_id)))
    
    print(experiment_visits %>%
        count(variation) %>%
        ggplot(aes(x=variation, y=n)) +
        geom_col())
    
    print(experiment_visits %>%
        count(first_joined_experiment) %>%
        ggplot(aes(x=first_joined_experiment, y=n)) +
        geom_line() +
        labs(title='Number of People Entering Experiment'))
    
    print(experiment_visits %>%
        count(first_joined_experiment, new_user) %>%
        ggplot(aes(x=first_joined_experiment, y=n, color=new_user)) +
        geom_line() +
        labs(title='Number of People Entering Experiment, shows affect of including new returning users in experiment'))
    
    print(experiment_visits %>%
        count(first_joined_experiment, variation) %>%
        ggplot(aes(x=first_joined_experiment, y=n, color=variation)) +
        geom_line())
    
    return (experiment_visits %>% select(-new_user))

}

#### Experiment 1

# let's start the experiment 2 months after our visits dataset, and run it for a month
start_date <- min(visits$visit_date) + 60
end_date <- start_date + 30 # 
# all paths
experiment_paths <- unique(paths)
# experiment 1
variation_names <- c("original", "variant")
experiment_id <- experiment_names[1]
experiment_visits_1 <- create_experiment_visits(start_date, end_date, experiment_paths, experiment_id, variation_names)
experiment_visits_1
```

```{r simulate_experiment_traffic_2}
#### Experiment 2
start_date <- min(visits$visit_date) + 75
end_date <- start_date + 30 # 
# all paths
experiment_paths <- paths[4] # just features page
# experiment 1
variation_names <- c("A", "B")
experiment_id <- experiment_names[2]
experiment_visits_2 <- create_experiment_visits(start_date, end_date, experiment_paths, experiment_id, variation_names)
experiment_visits_2
```

```{r simulate_experiment_traffic_currently_running}
#### Experiment 2
start_date <- Sys.Date() - 5
end_date <- start_date + 30 # 
# all paths
experiment_paths <- paths[1] # just homepage
# experiment 1
variation_names <- c("A", "B")
experiment_id <- experiment_names[length(experiment_names)]
experiment_visits_currently_running <- create_experiment_visits(start_date, end_date, experiment_paths, experiment_id, variation_names)
experiment_visits_currently_running
```

```{r experiments}
experiments_all <- rbind(experiment_visits_1,
                         experiment_visits_2,
                         experiment_visits_currently_running) %>%
    select(user_id, experiment_id, variation, first_joined_experiment, path) %>%
    arrange(user_id, experiment_id)

# ensure dataset is unique by user-id/experiment-id
stopifnot(nrow(distinct(experiments_all %>% select(user_id, experiment_id))) == nrow(experiments_all))

experiments_all
```

```{r adjust_crs}
# we want to adjust conversion rates for the people who were part of certain experiments
# such that the A/B groups have different conversion rates 
# some will have different CRs due to random noise, some will have differences in probability distributions
# i.e. true differences.


adjusted_conversion_rates <- inner_join(experiments_metrics,
                                        data.frame(metric_id=metrics_names, historical_conversion_rate=historical_conversion_rates),
                                        by = "metric_id") %>%
    select(-attribution_windows) %>%
    mutate(index=row_number())

# Experiment 1 has positive conversion rates, # we'll assum
adjusted_conversion_rates <- inner_join(adjusted_conversion_rates,
                                        expand.grid(index=adjusted_conversion_rates$index, variation=c('A', 'B')),
                                        by="index") %>%
    select(experiment_id, variation, metric_id, historical_conversion_rate)

adjusted_conversion_rates$adjusted_conversion_rate <- adjusted_conversion_rates$historical_conversion_rate

percent_change_adjustments <- c(
                    NA, # Experiment 1                        A   Sign Up
                    0.10, # Experiment 1                        B   Sign Up
                    NA, # Experiment 1                        A   Use Feature 1  
                    0.05, # Experiment 1                        B   Use Feature 1  
                    NA, # Experiment 1                        A   Talk to Sales  
                    NA, # Experiment 1                        B   Talk to Sales  
                    NA, # Experiment 1                        A   Pay/Subscribe  
                    0.03, # Experiment 1                        B   Pay/Subscribe  
                    NA, # Experiment 2                        A   Sign Up
                    -0.10, # Experiment 2                        B   Sign Up
                    NA, # Experiment 2                        A   Use Feature 1  
                    -0.05, # Experiment 2                        B   Use Feature 1  
                    NA, # Experiment 2                        A   Talk to Sales  
                    -0.03, # Experiment 2                        B   Talk to Sales  
                    NA, # Experiment 2                        A   Pay/Subscribe  
                    0.01, # Experiment 2                        B   Pay/Subscribe  
                    NA, # Experiment Sim Currently Running    A   Sign Up
                    0.10, # Experiment Sim Currently Running    B   Sign Up
                    NA, # Experiment Sim Currently Running    A   Use Feature 1  
                    0.05, # Experiment Sim Currently Running    B   Use Feature 1  
                    NA, # Experiment Sim Currently Running    A   Talk to Sales  
                    0.03, # Experiment Sim Currently Running    B   Talk to Sales  
                    NA, # Experiment Sim Currently Running    A   Pay/Subscribe  
                    0.03) # Experiment Sim Currently Running    B   Pay/Subscribe  
            

adjusted_conversion_rates <- adjusted_conversion_rates %>%
    mutate(adjusted_conversion_rate=ifelse(is.na(percent_change_adjustments),
                                           historical_conversion_rate,
                                           (percent_change_adjustments * historical_conversion_rate) + historical_conversion_rate))

# Experiment 1 has c("original", "variant") rather than A/B
temp_names <- c("original", "variant")
adjusted_conversion_rates <- adjusted_conversion_rates %>%
    mutate(variation = as.character(variation),
           variation = ifelse(experiment_id == experiment_names[1],
                              ifelse(variation == 'A', temp_names[1], temp_names[2]),
                              variation))
adjusted_conversion_rates
```

```{r conversion_rates_for_id_experiment_metric}
# now we want to determine the conversion rates for each person, based on experiment, metric_id, variation, so we can binom distribution based on the conversion rate
# if the person isn't part of an experiment, then we will use the historical conversion rate
names(historical_conversion_rates) <- metrics_names
# historical_conversion_rates[metrics_names[1]]

# create a dateframe that has a historical conversion rate for each user/metric combo
user_metric_crs <- expand.grid(user_id=unique(visits$user_id), metric_id=metrics_names) %>%
    arrange(user_id, metric_id) %>%
    mutate(historical_conversion_rate=historical_conversion_rates[metric_id])

# now add experiment/variation columns for users that were part of experiments
user_metric_crs <- full_join(user_metric_crs,
          experiments_all %>% select(user_id, experiment_id, variation), by='user_id')

# based on experiment/variation/metric, get the chosen conversion rate
user_metric_crs <- left_join(user_metric_crs %>% 
              mutate(metric_id = as.character(metric_id)),
          adjusted_conversion_rates %>%
              select(-historical_conversion_rate) %>%
              mutate(experiment_id = as.character(experiment_id),
                     metric_id = as.character(metric_id)),
          by=c('experiment_id', 'variation', 'metric_id')) %>%
    mutate(conversion_rate=ifelse(is.na(adjusted_conversion_rate), historical_conversion_rate, adjusted_conversion_rate)) %>%
    select(user_id, metric_id, conversion_rate)


# some people will have partipated in multiple experiments, so we'll take the average to get a dataset that is unique per user/metric
user_metric_crs <- user_metric_crs %>% 
    group_by(user_id, metric_id) %>%
    summarise(conversion_rate = mean(conversion_rate)) %>%
    ungroup()

stopifnot(length(unique(user_metric_crs$user_id)) == length(unique(visits$user_id)))

# now we will determine if each person convertes based on their conversion rate using the binomial distribution

#rbinom(1000, 1, 0.08)

simulate_conversion <- function(user_id, conversion_rate) {
    set.seed(user_id)
    return (rbinom(1, 1, conversion_rate))
}

# now we simulating them converting or not by using their assigned conversion rates as a probability in a binom distribution
user_metric_crs$converted <- as.logical(map2_dbl(user_metric_crs$user_id,
                    user_metric_crs$conversion_rate, 
                    ~ simulate_conversion(.x, .y)))

user_metric_crs %>%
    count(metric_id, converted) %>%
    mutate(n = n / length(unique(user_metric_crs$user_id))) %>%
    ggplot(aes(x=metric_id, y=n, group=converted, fill=converted)) +
    geom_col(position='dodge') +
    geom_text(aes(label=percent(n)))

conversion_data <- inner_join(user_metric_crs %>%
                                  filter(converted) %>%
                                  select(user_id, metric_id),
                              visits %>% 
                                  group_by(user_id) %>%
                                  summarise(first_visit=min(visit_date)),
                              by='user_id')

generate_offset <- function(user_id, metric) {
 
    # NOTE setting the seed is messing up the distribution   
    #  set.seed(user_id)
    rbinom(1, 30, attribution_windows_days[metric]/30)
}

names(attribution_windows_days) <- metrics_names
conversion_offsets <- map2_dbl(conversion_data$user_id, 
                               conversion_data$metric_id,
                               #~ rbinom(1, 30, attribution_windows_days[.y]/30))
                               ~ generate_offset(.x, .y))
conversion_data <- conversion_data %>%
    mutate(offset=conversion_offsets,
           conversion_date = first_visit + offset)

conversion_data %>%
    count(metric_id, offset) %>%
    mutate(offset=factor(offset)) %>%
    mutate(metric_id=fct_reorder(metric_id, n, .desc = TRUE)) %>%
    ggplot(aes(x=offset, y=n)) +
        geom_col() +
    facet_wrap( ~ metric_id, scales = 'free_y') +
    labs(title='Distribution of Days from First Visit to Event Conversion, for those that convert')

conversion_data %>%
    count(conversion_date, metric_id) %>%
    ggplot(aes(x=conversion_date, y=n)) +
        geom_line() +
    facet_wrap( ~ metric_id, scales = 'free_y') +
    labs(title='Daily Conversions')

conversion_data <- conversion_data %>%
    select(user_id, metric_id, conversion_date) %>%
    arrange(user_id, conversion_date)

conversion_data
```

```{r save_simulated_data}
write.csv(experiments_metrics, file='../shiny-app/simulated_data/attribution_windows.csv', row.names = FALSE)
write.csv(prior_data, file='../shiny-app/simulated_data/website_traffic.csv', row.names = FALSE)
write.csv(experiments_all, file='../shiny-app/simulated_data/experiment_traffic.csv', row.names = FALSE)
write.csv(conversion_data, file='../shiny-app/simulated_data/conversion_rate_data.csv', row.names = FALSE)
```


```{r}
#seeds <- 0:1000
seeds <- 1000:2000
#seeds <- signup_conversions$user_id
# temp <- function(seed, use_seeds) {
#     if(use_seeds) {
#         set.seed(seed)    
#     }
#     rbinom(1, 30, 3/30)
# }
temp <- function(seed, use_seeds) {
    if(use_seeds) {
        set.seed(seed)    
    }
    max(round(rnorm(1, 3, 2)), 0)
}
hist(map_dbl(seeds, ~ temp(., TRUE)))
hist(map_dbl(seeds, ~ temp(., FALSE)))
```


# historical traffic

```{r}
website_traffic <- prior_data


create_cohort <- function(date_object, cohort_method=month, pad_width=2) {

    return (
        paste0(year(date_object),
               '-',
               str_pad(cohort_method(date_object), width=pad_width, side='left', pad = '0'))
    )
}

#######
show_path <- TRUE
top_x_paths <- 2
start_date <- Sys.Date() - 270
end_date <- Sys.Date() - 30

cohort_type <- month
######

visitors_per_day_per_path <- website_traffic %>%
    filter(visit_date >= start_date & visit_date <= end_date) %>%
    group_by(user_id) %>%
    mutate(visit_index=rank(visit_date, ties.method = "first")) %>%
    ungroup() %>%
    mutate(date = factor(create_cohort(visit_date)),
           path= fct_lump(path,  n=top_x_paths),
           visit_type = ifelse(visit_index == 1, 'New', 'Returning'))
    
if(show_path) {

    visitors_per_day_per_path %>%
        count(date, path, visit_type) %>%
        ggplot(aes(x=date, y=n, color=path, group=path)) +
            geom_line() +
            geom_point() + 
            facet_grid(visit_type ~ .) + 
            scale_y_continuous(labels = comma_format()) +
            geom_text(aes(label=n), vjust=-1, size=3, check_overlap=TRUE) +    
            theme(axis.text.x = element_text(angle = 30, hjust = 1)) +
            labs(title='Website Visitors',
                 y='Number of Visits',
                 x='Month',
                 color='Path')
} else {

    visitors_per_day_per_path %>%
        count(date, visit_type) %>%
        ggplot(aes(x=date, y=n, color=visit_type, group=visit_type)) +
            geom_line() +
            geom_point() + 
            expand_limits(y=0) +
            scale_y_continuous(labels = comma_format()) +
            geom_text(aes(label=n), vjust=-1, size=3, check_overlap=TRUE) +
            theme(axis.text.x = element_text(angle = 30, hjust = 1)) +
            labs(title='Website Visitors',
                 y='Number of Visits',
                 x='Month',
                 color='Visitor Type')
}
```


































